import datetime
from typing import Annotated
from zoneinfo import ZoneInfo

from fastapi import APIRouter, HTTPException, Path, status

from app.core.config import get_settings
from app.schema.random_problem import (
    RandomProblemComplete,
    RandomProblemCreate,
    RandomProblemGivenUp,
    RandomProblemResponse,
)

settings = get_settings()
logger = settings.configure_logging()

router = APIRouter()


@router.get(
    "/random-problem/{user_id}",
    responses={
        status.HTTP_404_NOT_FOUND: {
            "description": "User not found",
        },
    },
    summary="ユーザーに紐づいたランダム問題の一覧を取得するAPIエンドポイント。",
    description="""
ユーザーIDに紐づくランダム問題の情報を返します。
user_idはパスパラメータとボディの両方で受け取りますが、両方の値が一致する必要があります。
現在はダミーデータを返す実装になっています。

ダミーデータの仕様
- user_idは受け取った値をそのまま返します。
- random_problem_idは1から3までの固定値を返します。
- longitudeとlatitudeは小数の固定値を返します。
- created_atは現在の日時に応じて異なる値を返します。
- ended_atは現在の日時に応じて異なる値を返します。
- statusは"pending", "given_up", "completed"がそれぞれ１問ずつ返されます。
- image_urlは"completed"の問題にのみ画像URLを返します。
""",
)
async def get_random_problem(user_id: int) -> list[RandomProblemResponse]:
    logger.info("Fetching random problems for user_id: %s", user_id)
    problems = [
        RandomProblemResponse(
            user_id=user_id,
            random_problem_id=1,
            longitude=135.6917,
            latitude=35.6895,
            created_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")),
            ended_at=None,
            status="pending",
            image_url=None,
        ),
        RandomProblemResponse(
            user_id=user_id,
            random_problem_id=2,
            longitude=135.3212,
            latitude=34.6937,
            created_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo"))
            - datetime.timedelta(days=365),
            ended_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")) - datetime.timedelta(days=60),
            status="given_up",
            image_url=None,
        ),
        RandomProblemResponse(
            user_id=user_id,
            random_problem_id=3,
            longitude=135.1917,
            latitude=35.1895,
            created_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo"))
            - datetime.timedelta(days=30),
            ended_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")) - datetime.timedelta(days=10),
            status="completed",
            image_url="http://example.com/image.jpg",
        ),
    ]
    return problems


@router.post(
    "/random-problem/create",
    status_code=status.HTTP_201_CREATED,
    summary="新しいランダム問題を作成するAPIエンドポイント。",
    description="""
ユーザーIDと中心座標、半径を指定して新しいランダム問題を作成します。
現在はダミーデータを返す実装になっています。

ダミーデータの仕様
- user_idは受け取った値をそのまま返します。
- random_problem_idは4を返します。
- longitudeとlatitudeはcenter_longitudeとcenter_latitudeをそのまま返します。
- created_atは現在の日時を返します。
- ended_atはNoneを返します。
- statusは"pending"を返します。
- image_urlはNoneを返します。
""",
)
async def create_random_problem(
    random_problem_create: RandomProblemCreate,
) -> RandomProblemResponse:
    logger.debug("Creating random problem: %s", random_problem_create)
    logger.info("Creating random problem for user_id: %s", random_problem_create.user_id)
    # 以下は仮のデータです。実際にはデータベースに保存する必要があります。
    new_problem = RandomProblemResponse(
        user_id=random_problem_create.user_id,
        random_problem_id=4,  # This would typically be generated by the database
        longitude=random_problem_create.center_longitude,
        latitude=random_problem_create.center_latitude,
        created_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")),
        ended_at=None,
        status="pending",
        image_url=None,
    )
    return new_problem


@router.patch(
    "/random-problem/complete/{random_problem_id}",
    summary="ランダム問題を完了するAPIエンドポイント。",
    description="""
ユーザーがランダム問題を完了した際に呼び出されます。
ユーザーIDとランダム問題ID、ユーザーの位置情報、および画像URLを受け取り、完了した問題の情報を返します。
現在はダミーデータを返す実装になっています。

ダミーデータの仕様
- user_idは受け取った値をそのまま返します。
- random_problem_idはパスパラメータから受け取った値をそのまま返します。
- longitudeとlatitudeはユーザーの位置情報をそのまま返します。
- created_atは過去の固定の日時を返します。
- ended_atは現在の日時を返します。
- statusは"completed"を返します。
- image_urlは受け取った値をそのまま返します。
""",
)
async def complete_random_problem(
    random_problem_complete: RandomProblemComplete,
    random_problem_id: Annotated[
        int,
        Path(..., description="ID of the random problem to complete"),
    ],
) -> RandomProblemResponse:
    if random_problem_complete.random_problem_id != random_problem_id:
        raise HTTPException(
            status_code=400,
            detail=(
                "Random problem ID mismatch: "
                f"{random_problem_complete.random_problem_id} != {random_problem_id}"
            ),
        )
    logger.debug("Completing random problem: %s", random_problem_complete)
    logger.info("Completing random problem with ID: %s", random_problem_complete.random_problem_id)
    # 以下は仮のデータです。実際にはデータベースから取得する必要があります。
    completed_problem = RandomProblemResponse(
        user_id=random_problem_complete.user_id,
        random_problem_id=random_problem_complete.random_problem_id,
        longitude=random_problem_complete.user_longitude,
        latitude=random_problem_complete.user_latitude,
        created_at=datetime.datetime(2024, 5, 1, 10, 0, 0, tzinfo=ZoneInfo("Asia/Tokyo")),
        ended_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")),
        status="completed",
        image_url=random_problem_complete.image_url,
    )
    return completed_problem


@router.patch(
    "/random-problem/given-up/{random_problem_id}",
    summary="ランダム問題を諦めるAPIエンドポイント。",
    description="""
ユーザーがランダム問題を諦めた際に呼び出されます。
ユーザーIDとランダム問題IDを受け取り、諦めた問題の情報を返します。
現在はダミーデータを返す実装になっています。

ダミーデータの仕様
- user_idは受け取った値をそのまま返します。
- random_problem_idはパスパラメータから受け取った値をそのまま返します。
- longitudeとlatitudeは固定の値を返します。
- created_atは過去の固定の日時を返します。
- ended_atは現在の日時を返します。
- statusは"given_up"を返します。
- image_urlはNoneを返します。
""",
)
async def give_up_random_problem(
    random_problem_given_up: RandomProblemGivenUp,
    random_problem_id: Annotated[
        int,
        Path(..., description="ID of the random problem to give up"),
    ],
) -> RandomProblemResponse:
    if random_problem_given_up.random_problem_id != random_problem_id:
        raise HTTPException(
            status_code=400,
            detail=(
                "Random problem ID mismatch: "
                f"{random_problem_given_up.random_problem_id} != {random_problem_id}"
            ),
        )
    logger.debug("Giving up random problem: %s", random_problem_given_up)
    logger.info("Giving up random problem with ID: %s", random_problem_given_up.random_problem_id)
    given_up_problem = RandomProblemResponse(
        user_id=random_problem_given_up.user_id,
        random_problem_id=random_problem_given_up.random_problem_id,
        longitude=135.6917,
        latitude=35.6895,
        created_at=datetime.datetime(2024, 5, 1, 10, 0, 0, tzinfo=ZoneInfo("Asia/Tokyo")),
        ended_at=datetime.datetime.now(tz=ZoneInfo("Asia/Tokyo")),
        status="given_up",
        image_url=None,
    )
    return given_up_problem
